#!/bin/bash

apt-get update -y
apt-get install -y docker.io nginx amazon-cloudwatch-agent

cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<EOF
{
  "agent": { "metrics_collection_interval":60, "run_as_user":"root" },
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list":[
          {
            "file_path":"/var/log/nginx/error.log",
            "log_group_name":"/aws/ec2/${log_group_prefix}-nginx",
            "log_stream_name":"{instance_id}-error"
          },
          {
            "file_path":"/var/log/nginx/access.log",
            "log_group_name":"/aws/ec2/${log_group_prefix}-nginx",
            "log_stream_name":"{instance_id}-access"
          },
          {
            "file_path":"/var/log/syslog",
            "log_group_name":"/aws/ec2/${log_group_prefix}-system",
            "log_stream_name":"{instance_id}-syslog"
          },
          {
            "file_path":"/var/log/application.log",
            "log_group_name":"/aws/ec2/${log_group_prefix}-application",
            "log_stream_name":"{instance_id}-app"
          }
        ]
      }
    }
  }
}
EOF

systemctl start amazon-cloudwatch-agent docker nginx
systemctl enable amazon-cloudwatch-agent docker nginx

touch /var/log/application.log
chmod 644 /var/log/application.log
